window.addEventListener("load", async function () {
    console.log("Checking TonConnect...");

    const TonConnect = window.TonConnectSDK ? window.TonConnectSDK.TonConnect : null;

    if (TonConnect) {
        console.log("TonConnect is available:", TonConnect);

        const tonConnect = new TonConnect({
            manifestUrl: 'https://pedramhatef.github.io/my-twa/tonconnect-manifest.json'
        });

        const connectButton = document.getElementById("connectWallet");

        connectButton.addEventListener("click", async () => {
            try {
                // Fetch available wallets
                const wallets = await tonConnect.getWallets();
                console.log("Available wallets:", wallets);

                if (wallets.length === 0) {
                    alert("No wallets found. Make sure you have a TON wallet installed.");
                    return;
                }

                // Show available wallets in console
                wallets.forEach((wallet, index) => {
                    console.log(`Wallet ${index + 1}:`, wallet);
                });

                // Select the first available wallet
                const selectedWallet = wallets[0];

                console.log("Connecting to wallet:", selectedWallet.name);
                console.log("Wallet Universal Link:", selectedWallet.universalLink);
                console.log("Wallet Bridge URL:", selectedWallet.bridgeUrl);

                // Try opening the universal link manually if needed
                window.open(selectedWallet.universalLink, "_blank");

                // Use the correct connection method
                await tonConnect.connect({
                    universalLink: selectedWallet.universalLink,
                    bridgeUrl: selectedWallet.bridgeUrl
                });

                alert("Wallet Connected!");
                connectButton.textContent = "Connected âœ…";
                connectButton.style.backgroundColor = "#28a745";
            } catch (error) {
                console.error("Wallet connection failed:", error);
                alert("Error connecting wallet. Check console for details.");
            }
        });

    } else {
        console.error("TonConnect is still not defined. Check script URL or console for errors.");
    }
});
